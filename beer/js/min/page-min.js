!function(){function e(){"thisweek"===y?(d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled","disabled"),i()):"all"===y?(d3.select("#showall").attr("disabled","disabled"),d3.select("#today").attr("disabled",null),d3.select("#previous").attr("disabled","disabled"),d3.select("#next").attr("disabled","disabled")):"previousweek"===y&&(d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),i())}function t(e){var t,a=/\+/g,r=/([^&=]+)=?([^&]*)/g,n=function(e){return decodeURIComponent(e.replace(a," "))},d=window.location.search.substring(1);for(l={};null!==(t=r.exec(d));)l[n(t[1])]=n(t[2]);w=window.location.origin+window.location.pathname,e&&e()}function a(e){return 0===e?"Jan":1===e?"Feb":2===e?"Mar":3===e?"Apr":4===e?"May":5===e?"Jun":6===e?"Jul":7===e?"Aug":8===e?"Sep":9===e?"Oct":10===e?"Nov":11===e?"Dec":void 0}function r(e){return 0===e?"Sunday":1===e?"Monday":2===e?"Tuesday":3===e?"Wednesday":4===e?"Thursday":5===e?"Friday":6===e?"Saturday":void 0}function n(e,t,a){e.forEach(function(e){e.time=new Date(e.time),e.time.setMinutes(e.time.getMinutes()-e.time.getMinutes()%10),e.time.setSeconds(0),e.time.setMilliseconds(0)});var r=d3.nest().key(function(e){return new Date(e.time.getFullYear(),e.time.getMonth(),e.time.getDate(),e.time.getHours(),e.time.getMinutes())}).rollup(function(e){return e.length}).entries(e),n={};n.now=t,n.yesterday=a,n.times=r,T.add_data(n,"key","values","Number of Beers Drunk"),T.draw()}function d(){t(),D=new WeekHandler,l.hasOwnProperty("from")&&l.hasOwnProperty("to")?(y="previousweek",D.current_week.start=new Date(l.from),D.current_week.end=new Date(l.to)):l.hasOwnProperty("all")?(y="all",u("")):y="thisweek";var a=D.get_query_string();e(),u(a)}function o(){y="previousweek",D.can_page_back()&&(D.page_back(),window.history.pushState({},"",w+D.get_query_string()),u(D.get_query_string())),e()}function s(){y="all",window.history.pushState({all:"all"},"",w+"?all=all"),u(""),e()}function i(){D.can_page_back()&&"all"!==y?d3.select("#previous").attr("disabled",null):d3.select("#previous").attr("disabled","disabled"),D.can_page_forward()&&"all"!==y?d3.select("#next").attr("disabled",null):d3.select("#next").attr("disabled","disabled")}function u(t){var d=new Date,o=new Date;o.setUTCDate(d.getUTCDate()-1),d.setUTCHours(d.getUTCHours()+5),o.setUTCHours(o.getUTCHours()+5);var s="?from="+o.toUTCString()+"&to="+d.toUTCString();queue().defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/venues"+t).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/breweries"+t).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/beers"+t).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+t).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+s).await(function(t,s,l,h,b,_){if(s=JSON.parse(s.response),l=JSON.parse(l.response),h=JSON.parse(h.response),b=JSON.parse(b.response),_=JSON.parse(_.response),d.setUTCHours(d.getUTCHours()-5),o.setUTCHours(o.getUTCHours()-5),n(_,d,o),t&&console.log(t),0===b.length)return y="previousweek",D.can_page_back()&&(D.page_back(),window.history.pushState({},"",w+D.get_query_string()),u(D.get_query_string())),void e();var m=Date.parse(b[0].time),k=m;b.forEach(function(e){var t=Date.parse(e.time);m>t&&(m=t),t>k&&(k=t)});var T,U,S=new Date(k),x=new Date(m);window.innerWidth<760?(T=""+S.getUTCDate()+"/"+(S.getUTCMonth()+1)+"/"+S.getUTCFullYear(),U=""+x.getUTCDate()+"/"+(x.getUTCMonth()+1)+"/"+x.getUTCFullYear()):(T=""+r(S.getUTCDay())+" "+S.getUTCDate()+" "+a(S.getUTCMonth())+" "+S.getUTCFullYear(),U=""+r(x.getUTCDay())+" "+x.getUTCDate()+" "+a(x.getUTCMonth())+" "+x.getUTCFullYear()),d3.select("#from-date").text(U),d3.select("#to-date").text(T);var M=d3.nest().key(function(e){return e.beer_style}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(h),N={};M.forEach(function(e){N[e.key]=[],h.forEach(function(t){t.beer_style===e.key&&N[e.key].push(t)}),N[e.key].sort(function(e,t){return e.count>t.count?-1:e.count<t.count?1:0}),N[e.key]=N[e.key].slice(0,10)});var H=function(e){var t="";return N[e.key].forEach(function(e,a){t+=""+(a+1)+". "+e.beer_name+" "+e.beer_abv+"% <br>"}),t},O=function(e){var t="";return t+="<img src='"+e.beer_label+"' width=40><br>"+e.beer_name+"<br>ABV: "+e.beer_abv+"%<br>Style: "+e.beer_style},E=function(e){var t="";return t+=e.venue_name+"<br>",e.contact.twitter&&(t+=e.contact.twitter+"<br>"),e.location.venue_address&&(t+=e.location.venue_address+"<br>"),e.location.venue_city&&(t+=e.location.venue_city),t},J=function(e){var t="";return t+="<img src='"+e.brewery_label+"' width=40><br>"+e.brewery_name+"<br>"+e.contact.url+"<br>@"+e.contact.twitter};g.add_data(h,"beer_name","count","Number of checkins per beer",!0,O),p.add_data(l,"brewery_name","count","Number of checkins per brewery",!0,J),f.add_data(M,"key","values","Number of checkins per style",!0,H),v.add_data(s,"venue_name","count","Number of checkins per venue",!0,E),C.add_data(b,s,"venue_id","venue_name","venue","Checkins at Venue (cumulative)"),g.draw(),p.draw(),f.draw(),v.draw(),c(b),i()})}function c(e){function t(e){return(10>e?"0":"")+e+":00"}var a=[],r=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],n=[];for(var d in d3.range(0,24))n.push({time:t(d),count:0,average:0});e.forEach(function(e){var t=new Date(e.time),d=t.toDateString();-1===a.indexOf(d)&&(a.push(d),r[t.getDay()].days_seen+=1),r[t.getDay()].count+=1,n[t.getHours()].count+=1}),r.forEach(function(e){e.days_seen>0&&(e.average=e.count/e.days_seen)}),n.forEach(function(e){e.average=e.count/a.length}),b.add_data(r,"day","average","Average beers drunk per day",!1,null),_.add_data(n,"time","average","Average beers drunk per hour",!1,null),b.draw(),_.draw(),d3.xhr("http://bardiff-martinjc.rhcloud.com/api/checkins",function(e,t){t=JSON.parse(t.response),m.add_data(t),m.draw(),k.add_data(t),k.draw()})}var l,w,y="thisweek";window.onpopstate=function(){t(d)},window.onpopstate();var h={top:10,bottom:140,left:90,right:10},g=new BarChart("#beers .vis",h),f=new BarChart("#styles .vis",h),p=new BarChart("#breweries .vis",h),v=new BarChart("#venues .vis",h),b=new BarChart("#day .vis",h),_=new BarChart("#time .vis",h),m=new DayChart("#year2015 .vis",2015),k=new DayChart("#year2016 .vis",2016),C=new TimeLine("#where_line .vis",h),T=new SingleDayChart("#pastday .vis",{top:10,bottom:70,left:50,right:10});window.addEventListener("resize",function(){b.draw(),_.draw(),m.draw(),k.draw(),g.draw(),p.draw(),f.draw(),v.draw(),C.draw(),T.draw()});var D;d3.select("#previous").on("click",o),d3.select("#next").on("click",function(){D.can_page_forward()&&(D.page_forward(),window.history.pushState({},"",w+D.get_query_string()),u(D.get_query_string()),y=D.can_page_forward()?"previousweek":"thisweek"),e()}),d3.select("#today").on("click",function(){y="thisweek",window.history.pushState({},"",w),e(),d()}),d3.select("#showall").on("click",s)}();