/* global L, console, foursq_client_id, foursq_client_secret, zooms, lastfm_api_key, lastfm_client_secret, LastFM */(function(){function o(e,t){return decodeURIComponent(((new RegExp("[?|&|#]"+e+"="+"([^&;]+?)(&|#|;|$)")).exec(t)||[,""])[1].replace(/\+/g,"%20"))||null}function u(){var e,t=o("auth",location.search);if(localStorage.lastfmauth===undefined&&t==="lastfm"){e=o("token",location.search);e!==null&&s.auth.getSession({api_key:lastfm_api_key,token:e},{success:function(e){localStorage.lastfmauth=JSON.stringify(e.session)},error:function(e,t){console.log(t)}})}if(localStorage.foursquareauth===undefined){t=o("access_token",window.location.hash);console.log(t);t=decodeURIComponent(((new RegExp("[?|&|#]access_token=([^&;]+?)(&|#|;|$)")).exec(window.location.hash)||[,""])[1].replace(/\+/g,"%20"))||null;t!==null&&(localStorage.foursquareauth=t)}}function a(){$.each(n,function(t,n){e.getBounds().contains(n.getLatLng())?e.addLayer(n):e.removeLayer(n)});$.each(i,function(t,n){e.getBounds().contains(n.getLatLng())?e.addLayer(n):e.removeLayer(n)})}function f(e){var r=L.icon({iconUrl:"img/beer.png",iconSize:[32,32],popupAnchor:[0,-16]}),i=new L.marker([e.location.lat,e.location.lng],{title:e.name,icon:r}),s="";s+="<a href='"+e.canonicalUrl+"'><img style='float:left; padding:4px' src='img/foursquare_icon.png' /><h1>"+e.name+"</h1></a>";i.bindPopup(s);if(t.indexOf(e.id)<=-1){t.push(e.id);n.push(i)}}function l(e){var r=L.icon({iconUrl:"img/beer_rec.png",iconSize:[48,48],popupAnchor:[0,-24]}),i=new L.marker([e.venue.location.lat,e.venue.location.lng],{title:e.venue.name,icon:r,zIndexOffset:1e3}),s="";s+="<a href='"+e.venue.canonicalUrl+"'><img style='float:left; padding:4px' src='img/foursquare_icon.png' /><h1>"+e.venue.name+"</h1></a>";if(e.reasons.count>0){s+="<h3>Recommended because:</h3><ul>";$.each(e.reasons.items,function(e,t){s+="<li>"+t.summary+"</li>"})}s+="</ul>";e.venue.likes.summary!==undefined&&(s+="<h4>Liked by:</h4><p>"+e.venue.likes.summary+"</p>");i.bindPopup(s);if(t.indexOf(e.venue.id)<=-1){t.push(e.venue.id);n.push(i)}}function c(e){var t=L.icon({iconUrl:"img/music.png",iconSize:[32,32],popupAnchor:[0,-16]}),n=new L.marker([e.venue.location["geo:point"]["geo:lat"],e.venue.location["geo:point"]["geo:long"]],{title:e.title,icon:t}),s="";s+="<a href='"+e.url+"'><img style='float:left; padding:4px' src='img/lastfm_logo.png' /><h1>"+e.title+"</h1></a><h3>"+e.startDate+"</h3><p>"+e.venue.name+"</p>";n.bindPopup(s);if(r.indexOf(e.id)<=-1){r.push(e.id);i.push(n)}}function h(e){var t=L.icon({iconUrl:"img/music_rec.png",iconSize:[48,48],popupAnchor:[0,-24]}),n=new L.marker([e.venue.location["geo:point"]["geo:lat"],e.venue.location["geo:point"]["geo:long"]],{title:e.title,icon:t,zIndexOffset:1e3}),s="";s+="<a href='"+e.url+"'><img style='float:left; padding:4px' src='img/lastfm_logo.png' /><h1>"+e.title+"</h1></a><h3>"+e.startDate+"</h3><p>"+e.venue.name+"</p>";n.bindPopup(s);if(r.indexOf(e.id)<=-1){r.push(e.id);i.push(n)}}function p(e){console.log("not implemented yet! - showError "+e)}function d(e){p(e)}function v(){console.log("not implemented yet! - onLocationFound")}function m(){var t,n=e.getCenter(),r=n.lat+","+n.lng,i=Math.max(e.getSize().x,e.getSize().y),o=e.getZoom(),u=Math.min(zooms[o]*i,1e5);$.getJSON("https://api.foursquare.com/v2/venues/search",{ll:r,radius:u,limit:50,intent:"browse",categoryId:"4bf58dd8d48988d155941735,4bf58dd8d48988d11b941735,4d4b7105d754a06376d81259",client_id:foursq_client_id,client_secret:foursq_client_secret,v:20130420}).done(function(e){$.each(e.response.venues,function(e,t){console.log(t);f(t)});a()});$.getJSON("http://ws.audioscrobbler.com/2.0/",{method:"geo.getevents","long":n.lng,lat:n.lat,api_key:lastfm_api_key,limit:30,format:"json",distance:u/1e3}).done(function(e){$.each(e.events.event,function(e,t){c(t)});a()});if(localStorage.lastfmauth){t=JSON.parse(localStorage.lastfmauth);s.user.getRecommendedEvents({latitude:n.lat,longitude:n.lng,limit:40},t=t,{success:function(e){$.each(e.events.event,function(e,t){h(t)});a()},error:function(e,t){console.log(t)}})}localStorage.foursquareauth&&$.getJSON("https://api.foursquare.com/v2/venues/explore",{ll:r,radius:u,section:"drinks",limit:50,oauth_token:localStorage.foursquareauth,v:20130420}).done(function(e){$.each(e.response.groups,function(e,t){console.log(t);$.each(t.items,function(e,t){l(t)})});a()})}function g(){var t="http://{s}.tile.cloudmade.com/364b324514d240c8afdd7ba132fd4841/997/256/{z}/{x}/{y}.png",n="Map data Â© OpenStreetMap contributors",r=new L.TileLayer(t,{minZoom:8,maxZoom:18,attribution:n});e.addLayer(r);e.locate({setView:!0,maxZoom:16});u();e.on("locationerror",d);e.on("locationfound",v);e.on("moveend",m)}var e=L.map("map"),t=[],n=[],r=[],i=[],s=new LastFM({apiKey:lastfm_api_key,apiSecret:lastfm_client_secret});g()})();