function parseText(e){words=[];tags=d3.entries(e).sort(function(e,t){return t.value-e.value});generate()}function generate(){layout.font("impact");layout.spiral("archimedean");fontSize=d3.scale.log().range([10,100]);tags.length&&fontSize.domain([+tags[tags.length-1].value||1,+tags[0].value]);complete=0;words=[];layout.stop().words(tags.slice(0,250)).start()}function draw(e,t){var n,r,i;scale=t?Math.min(w/Math.abs(t[1].x-w/2),w/Math.abs(t[0].x-w/2),h/Math.abs(t[1].y-h/2),h/Math.abs(t[0].y-h/2))/2:1;words=e;n=vis.selectAll("text").data(words,function(e){return e.text.toLowerCase()});n.transition().duration(1e3).attr("transform",function(e){return"translate("+[e.x,e.y]+")rotate("+e.rotate+")"}).style("font-size",function(e){return e.size+"px"});n.enter().append("text").attr("text-anchor","middle").attr("transform",function(e){return"translate("+[e.x,e.y]+")rotate("+e.rotate+")"}).style("font-size",function(e){return e.size+"px"}).on("click",function(e){show_similar(e.text)}).style("opacity",1e-6).transition().duration(1e3).style("opacity",1);n.style("font-family",function(e){return e.font}).style("fill",function(e){return fill(e.text.toLowerCase())}).text(function(e){return e.text.toLowerCase()});r=background.append("g").attr("transform",vis.attr("transform"));i=r.node();n.exit().each(function(){i.appendChild(this)});r.transition().duration(1e3).style("opacity",1e-6).remove();vis.transition().delay(1e3).duration(750).attr("transform","translate("+[w>>1,h>>1]+")scale("+scale+")")}function downloadPNG(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=w;e.height=h;t.translate(w>>1,h>>1);t.scale(scale,scale);words.forEach(function(e){t.save();t.translate(e.x,e.y);t.rotate(e.rotate*Math.PI/180);t.textAlign="center";t.fillStyle=fill(e.text.toLowerCase());t.font=e.size+"px "+e.font;t.fillText(e.text,0,0);t.restore()});d3.select(this).attr("href",e.toDataURL("image/png"))}function downloadSVG(){d3.select(this).attr("href","data:image/svg+xml;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(svg.attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML))))}function reset(){$("#selected-tag").html("");$("#tag-info").slideUp(1e3);$(".accordion-inner > ul > li").show(1e3)}function show_info(e){$("#selected-tag").html("");$("#tag-info").slideUp(500);$(".accordion-inner > ul > li").show(1e3);$(".selected").removeClass("selected");$("#"+e).addClass("selected")}function show_similar(e){var t,n,r,i,s,o;$("#tag-info").slideDown(1e3);$("#selected-tag").html(e);$(".accordion-inner > ul > li").show(1e3);$(".collapse").collapse("show");for(t in band_data){n=band_data[t].bands;for(r in n){i=Object.keys(n[r].tags);s=!1;for(o in i)i[o]===e&&(s=!0);s||$("#"+n[r].artist_name).hide(800)}}}var tags,fontSize,band_data,fill=d3.scale.category20b(),w=800,h=600,words=[],max=250,scale=1,complete=0,maxLength=30,layout=d3.layout.cloud().timeInterval(10).size([w,h]).fontSize(function(e){return fontSize(+e.value)}).text(function(e){return e.key.toLowerCase()}).rotate(function(e){return~~Math.random()*90}).on("end",draw),svg=d3.select("#vis").append("svg").attr("width",w).attr("height",h),background=svg.append("g"),vis=svg.append("g").attr("transform","translate("+[w>>1,h>>1]+")");$("#remove-tag").on("click",function(){reset()});$(document).ready(function(){$("#collapseSat").collapse("show");w=$("#vis").width();h=$("#vis").height();$.getJSON("data/bands.json",function(e){var t,n,r,i;band_data=e;for(t in band_data){n=band_data[t].day;r=band_data[t].bands;for(i in r){$("#"+n+" > ul").append('<li id="'+r[i].artist_name+'">'+r[i].artist+"</li>");if(!$.isEmptyObject(r[i].tags)){$("#"+r[i].artist_name).addClass("clickable");(function(e){$("#"+r[i].artist_name).on("click",function(){show_info(e.artist_name,e.artist);parseText(e.tags)})})(r[i])}}}});$(window).resize(function(){w=$("#vis").width();h=$("#vis").height();generate()})});